<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" type="text/css" href="styles.css">
        <meta charset="UTF-8">
        <title>tree</title>
    </head>
    <body>
        <div class="mainDiv">
            <button id="btnDraw" type="button">draw tree</button>
            
            <button id="btnSnowflake" type="button">draw snowflake</button>
            <input id="snowflakeSlider" type="range" min="-1" max="5" value="1" />

            <button id="btnBarnsleyFern" type="button">draw Barnsley fern</button>
            <input id="barnsleySlider" type="range" min="2000" max="50000" value="5000" />
            <div id="canvasDiv" class="canvasDiv2">
                <canvas id="myCanvas" width="800" height="1000"></canvas>
            </div>
        </div>
        
        <script>

            var myCanvas = document.getElementById("myCanvas");
            var ctx = myCanvas.getContext("2d");

            const initCanvas = () => {
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(-myCanvas.width, -myCanvas.height, myCanvas.width, myCanvas.height);
                ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);
                // var canvasDiv = document.getElementById("canvasDiv");
                // ctx.canvas.width = canvasDiv.width;
                // ctx.canvas.heigth = canvasDiv.heigth;
            }

            const drawBarnsleyFern = (limit) => {
                let width = myCanvas.width, height = myCanvas.height;
                let x = 0.,
                    y = 0.,
                    xw = 0.,
                    yw = 0.,
                    r;

                const randgp = (max) => Math.floor(Math.random() * max);
                
                initCanvas();
                for (let i = 0; i < limit; i++) {
                    r = randgp(100);
                    if (r <= 1) {
                        xw = 0;
                        yw = 0.16*y;
                    } else if (r <= 8) {
                        xw = 0.2 * x - 0.26 * y;
                        yw = 0.23 * x + 0.22 * y + 1.6;
                    } else if (r <= 15) {
                        xw = -0.15 * x + 0.28 * y;
                        yw = 0.26 * x + 0.24 * y + 0.44;
                    } else {
                        xw = 0.85 * x + 0.04 * y;
                        yw = -0.04 * x + 0.85 * y + 1.6;
                    }
                    x = xw;
                    y = yw;
                    ctx.fillStyle = "green";
                    ctx.fillRect(x * 50 + 260, -y * 50 + 540, 1, 1);
                }
            };

            const barnsleySlider = document.getElementById("barnsleySlider");
            barnsleySlider.oninput = (ev, ui) => {
                console.log("barnsleySlider", barnsleySlider.value);
                drawBarnsleyFern(barnsleySlider.value);
            };


            const drawSnowflake = async () => {
                initCanvas();
                let width = myCanvas.width;
                let height = myCanvas.height;

                const slider = document.getElementById("snowflakeSlider");
                slider.oninput = (ev, ui) => {
                    ctx.clearRect(-width/2, -height/2, width, height);
                    drawSnflake();
                };

                const drawSnflake = () => {
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                    ctx.translate(width/2, height/2);

                    const p0 = {
                        x: 0,
                        y: -321
                    },
                    p1 = {
                        x: 278,
                        y: 160
                    },
                    p2 = {
                        x: -278,
                        y: 160
                    };

                    const koch = (p0, p1, limit) => {
                        let dx = p1.x - p0.x,
                            dy = p1.y - p0.y,
                            dist = Math.sqrt(dx*dx + dy*dy),
                            unit = dist/3,
                            angle = Math.atan2(dy, dx),
                            pA = {
                                x: p0.x + dx/3,
                                y: p0.y + dy/3
                            },
                            pC = {
                                x: p1.x - dx/3,
                                y: p1.y - dy/3
                            },
                            pB = {
                                x: pA.x + Math.cos(angle - Math.PI/3) * unit,
                                y: pA.y + Math.sin(angle - Math.PI/3) * unit
                            };
                        
                            if (limit > 0) {
                                koch(p0, pA, limit - 1);
                                koch(pA, pB, limit - 1);
                                koch(pB, pC, limit - 1);
                                koch(pC, p1, limit - 1);
                            } else if (limit < 0) {
                                ctx.beginPath();
                                ctx.moveTo(p0.x, p0.y);
                                ctx.lineTo(p1.x, p1.y);
                                ctx.stroke();
                            } else {
                                ctx.beginPath();
                                ctx.moveTo(p0.x, p0.y);
                                ctx.lineTo(pA.x, pA.y);
                                ctx.lineTo(pB.x, pB.y);
                                ctx.lineTo(pC.x, pC.y);
                                ctx.lineTo(p1.x, p1.y);
                                ctx.stroke();
                            }
                    };

                    koch( p0, p1, slider.value);
                    koch( p1, p2, slider.value);
                    koch( p2, p0, slider.value);
                };

                drawSnflake();
            };

            const drawTree = async () => {
                
                initCanvas();

                function draw(startX, startY, len, angle, branchWidth) {
                    
                    ctx.lineWidth = branchWidth;
                    ctx.beginPath();
                    ctx.save();

                    ctx.translate(startX, startY);
                    ctx.rotate(angle * Math.PI/180);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(0, -len);
                    ctx.stroke();

                    ctx.shadowBlur = 15;
                    ctx.shadowColor = "rgba(0,0,0,0.8)";

                    if (len<10) {
                        ctx.restore();
                        return;
                    }
                    draw(0, -len, len*0.8, angle-15, branchWidth*0.8);
                    draw(0, -len, len*0.8, angle+15, branchWidth*0.8);

                    ctx.restore();
                }
                let width = myCanvas.width;
                let height = myCanvas.height;
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                // ctx.translate(width, height);
                draw(400, 600, 120, 0, 10);
            };

            const btn = document.getElementById("btnDraw");
            btn.addEventListener("click", (event) => {
                console.log("Start drawing");
                drawTree();
            });

            const btnSnow = document.getElementById("btnSnowflake");
            btnSnow.addEventListener("click", (event) => {
                console.log("Snowflake to appear");
                drawSnowflake();
            });

            const btnFern = document.getElementById("btnBarnsleyFern");
            btnFern.addEventListener("click", (event) => {
                console.log("btnBarnsleyFern clicked");
                drawBarnsleyFern(document.getElementById("barnsleySlider").value);
            })
        </script>
    </body>
</html>